# Project Rules & Guidelines

This file consolidates all development rules and guidelines for project, incorporating standards from multiple sources including general development principles, project-specific patterns, Context7 libraries, and the comprehensive project structure documentation.

## IMPORTANT: Documentation and File Management Policy

**No Documentation Files:** Do NOT generate explanatory files, guides, tutorials, or any standalone documentation files (README.md, GUIDE.md, etc.).

**Documentation Location:** All documentation must be added as **short, clear, and concise appendices** exclusively in this file (`.claude/CLAUDE.md`).

**Documentation Style:** ALL documentation in this file MUST be **extremely short, clear, and concise**. Avoid verbosity, redundancy, or unnecessary explanations. Get to the point immediately.

**Temporary Files:** Any temporary files generated during development or testing **MUST be deleted** immediately after use.

## 1. Communication and Language

**Primary Language:** All communication with AI assistants will be exclusively in **Spanish**.

**Code and Comments:**

- Generated code will always be in **English**.
- Comments within the code will also be in **English**, facilitating universal understanding and maintenance.

## 2. Software Development Principles

Excellence in development is paramount. Therefore, I strictly adhere to:

**SOLID Principles:** To create robust, maintainable, and scalable software.

- **S**ingle Responsibility Principle
- **O**pen/Closed Principle
- **L**iskov Substitution Principle
- **I**nterface Segregation Principle
- **D**ependency Inversion Principle

**DRY (Don't Repeat Yourself) Principle:** To avoid redundancy and improve code efficiency and maintainability.

**Test-Driven Development (TDD):** Writing tests before functional code to ensure quality and expected behavior from the outset.

## 3. Portable Configuration Philosophy

**Core Philosophy:** `~/.config/` is a **portable git repo** that works on any platform (nix-darwin, NixOS, Arch Linux) without modification. Nix is responsible for **installing** packages only. All user configuration lives in `~/.config/` and is **platform-agnostic**.

### Directory Structure

```
~/.config/                              # Git repo (portable)
  shell/
    env.fish, env.nu, env.zsh           # Portable env (PATH with platform detection)
    bashrc, zshrc, bash_profile         # Symlinked to ~/ by bootstrap.sh
    integrations/                       # Git-tracked (portable, rarely change)
      zoxide.{fish,nu,zsh,bash}
      atuin.{fish,nu,zsh,bash}
      yazi.{fish,nu,zsh,bash}
      cldy.{fish,nu}
      mise.{fish,nu,zsh,bash}
    bootstrap.sh                        # Generates ~/.cache/shell/ + symlinks dotfiles
  hosts/                                # Non-Nix platform setup scripts
    arch/initialize.sh                  # pacman packages + bootstrap + tools
    macos-brew/initialize.sh            # brew packages + bootstrap + tools + macOS setup
  fish/config.fish                      # Sources from shell/
  nushell/config.nu                     # Sources from shell/
  nushell/env.nu                        # Real file, sources shell/env.nu
  nixos/                                # Nix configuration ONLY (nix-darwin + NixOS)
    flake.nix, hosts/, lib/, secrets/

~/.cache/shell/                         # Ephemeral, NOT in git (absolute paths)
  starship.{fish,nu,zsh,bash}           # Generated by bootstrap.sh
  direnv.{fish,zsh,bash}                # Generated by bootstrap.sh
```

### Rules

**Rule 1: `~/.config/nixos/`** - Nix/NixOS/nix-darwin `.nix` files and SOPS secrets ONLY.

**Rule 2: `~/.config/<app>/`** - User-editable app configuration. No Nix-generated files.

**Rule 3: `~/.*` Dotfiles** - User-managed (`.zshrc`, `.bashrc`). No Nix-generated files.

**Rule 4: `~/.cache/shell/`** - Ephemeral files with absolute system paths. Generated by `bootstrap.sh`, not tracked in git.

### Shell Integration Architecture

**Tracked integrations** (`~/.config/shell/integrations/`): Output of tools like `zoxide init`, `atuin init`, `mise activate`. These are portable (no absolute paths) and committed to git. Regenerate with the tool commands when versions change.

**Cached integrations** (`~/.cache/shell/`): Output of `starship init`, `direnv hook`. These contain absolute paths to binaries and must be regenerated per-machine via `bootstrap.sh`.

**Environment files** (`~/.config/shell/env.{fish,nu,zsh}`): Portable PATH setup with platform detection (`if test -d /nix`), EDITOR, SOPS secrets.

### Platform Setup

**nix-darwin:** `darwin-rebuild switch` installs packages and runs `bootstrap.sh` via activation script. Update packages: `cd ~/.config/nixos && nix flake update && darwin-rebuild switch --flake .`

**NixOS:** `nixos-rebuild switch` installs packages and runs `bootstrap.sh` via activation script.

**Arch Linux:** `git clone <repo> ~/.config && bash ~/.config/hosts/arch/initialize.sh`

**macOS (Homebrew only):** `git clone <repo> ~/.config && bash ~/.config/hosts/macos-brew/initialize.sh`

### Home Manager Activation Scripts

Activation scripts should be **minimal**. The only shell-related activation script is `shellBootstrap` which runs `bootstrap.sh`.

Other valid activation scripts: symlinks (hammerspoon), tool installation (claude, opencode), directory creation (karabiner).

## 4. Shell Prompt Configuration (Starship)

**Starship** is the prompt for all shells. Nix installs it, `bootstrap.sh` generates init scripts in `~/.cache/shell/`, user configures in `~/.config/starship.toml`.

## 5. Secret Management with SOPS

**Philosophy:** Decrypt secrets on-the-fly in memory using `sops -d`. Never write plaintext secrets to disk.

**Architecture:**
```
~/.config/nixos/secrets/*.yaml  (ENCRYPTED in git)
        ↓ sops -d (runtime, conditional)
    ENV vars in memory (never on disk)
```

**Age Private Key Location:** `~/.local/share/sops/age/keys.txt` (permissions: `600`)

**Portable detection** in env files:
```fish
# Only load if sops is installed AND secret file exists
if command -q sops; and test -f "$HOME/.config/nixos/secrets/gemini_api_key.yaml"
    set -gx GEMINI_API_KEY (sops -d ... | yq '.GEMINI_API_KEY' | string trim)
end
```

**Security Rules:**
- Encrypted secrets in git (`~/.config/nixos/secrets/*.yaml`)
- In-memory decryption only (`sops -d`)
- Age key outside git (`~/.local/share/`)
- NEVER use `sops-nix` with `path =` (creates plaintext files)

## 6. Per-Project Dev Environments

### mise (Language Version Manager)

**mise** manages programming language versions per-project. Installed system-wide via Nix/pacman, activated per-shell via `~/.config/shell/integrations/mise.{fish,nu,zsh,bash}`.

Usage: `mise use node@22` creates `.mise.toml` in the project directory.

### devenv + direnv (Nix-based environments)

Use `devenv` + `direnv` for project-scoped Nix environments with services (DBs, Redis).

**Project structure:**
```
~/projects/my-app/
├── devenv.nix          # Languages, packages, services
├── devenv.yaml         # Nix inputs
├── .envrc              # use devenv
├── .devenv/            # State - gitignored
└── .direnv/            # Cache - gitignored
```

**`.envrc`:** `use devenv`

**`.gitignore`:** Add `.devenv/` and `.direnv/`
