# ðŸš Nushell + sops-nix: GuÃ­a Completa

## â“ El Problema Original

```bash
# En nushell:
~/.config/nixos> sops secrets/google/gemini_api_key.yaml
Error: nu::shell::external_command
  Ã— External command failed
  â”‚ Command `sops` not found
```

**Causas:**
1. âŒ `sops` no estaba instalado (no se habÃ­a hecho rebuild)
2. âŒ Nushell no tenÃ­a configurado el PATH de Nix

---

## âœ… SoluciÃ³n Implementada

### **1. PATH Configurado AutomÃ¡ticamente**

**macOS (work-mp-m3-max y mp-i9-16i):**
- âœ… `programs.nushell.extraEnv` con PATH completo
- âœ… Home-manager gestiona env.nu automÃ¡ticamente

**NixOS (lenovo-nixos-btw):**
- âœ… Activation script que genera `env.nu` con PATH
- âœ… Se ejecuta en cada rebuild

### **2. Variables de Entorno de Secretos**

Todos los hosts configurados con:
- âœ… `$env.OPENAI_API_KEY`
- âœ… `$env.ANTHROPIC_API_KEY`
- âœ… `$env.GEMINI_API_KEY`
- âœ… `$env.POSTGRES_PASSWORD`
- âœ… `$env.GITHUB_TOKEN`
- âœ… Y mÃ¡s...

---

## ðŸš€ Pasos para Activar

### **PASO 1: Rebuild (CRÃTICO)**

```bash
cd ~/.config/nixos

# En macOS:
darwin-rebuild switch --flake .

# En NixOS:
sudo nixos-rebuild switch --flake .
```

**QuÃ© hace el rebuild:**
1. Instala `sops` (si no estaba)
2. Instala `age` (si no estaba)
3. Configura env.nu con PATH correcto
4. Configura variables de entorno de secretos

---

### **PASO 2: Verifica InstalaciÃ³n**

```bash
# 1. Cierra y abre NUEVO terminal

# 2. Entra a nushell
nu

# 3. Verifica que sops estÃ¡ disponible
which sops
# /run/current-system/sw/bin/sops âœ…

# 4. Verifica PATH completo
echo $env.PATH
# Debe incluir:
# - /run/current-system/sw/bin
# - ~/.nix-profile/bin
# - /nix/var/nix/profiles/default/bin

# 5. Verifica variables de entorno (si ya tienes secretos)
echo $env.OPENAI_API_KEY
# sk-proj-xxxxx âœ…
```

---

### **PASO 3: Usar sops desde Nushell**

```bash
# Entra a nushell
nu

# Navega a tu config
cd ~/.config/nixos

# Edita secretos (funciona perfectamente ahora)
sops secrets/ai.yaml

# El editor se abre en texto plano
# Editas lo que necesites
# Guardas y cierras
# âœ… SOPS encripta automÃ¡ticamente

# Verifica encriptaciÃ³n
cat secrets/ai.yaml
# openai_api_key: ENC[AES256_GCM,data:...]
# âœ… Encriptado!
```

---

## ðŸ“Š ConfiguraciÃ³n TÃ©cnica

### **macOS (Declarativo via home-manager)**

```nix
# hosts/darwin/work-mp-m3-max/home/hugoruiz/home.nix

programs.nushell = {
  enable = true;

  environmentVariables = {
    EDITOR = "nvim";
    TERMINAL = "alacritty";
  };

  extraEnv = ''
    # Configure PATH for Nix/Darwin
    $env.PATH = (
      $env.PATH
      | split row (char esep)
      | prepend /run/current-system/sw/bin
      | prepend $"($env.HOME)/.nix-profile/bin"
      | prepend /nix/var/nix/profiles/default/bin
      | prepend $"($env.HOME)/.local/bin"
      | prepend $"($env.HOME)/.npm-global/bin"
      | prepend $"($env.HOME)/.cargo/bin"
      | uniq
    )

    # Load secrets from sops-nix
    $env.OPENAI_API_KEY = (cat ${config.sops.secrets.openai_api_key.path} | str trim)
    # ... mÃ¡s secretos
  '';
};
```

### **NixOS (Activation Script)**

```nix
# hosts/nixos/lenovo-nixos-btw/home/hugoruiz/home.nix

home.activation.configureNushellEnv = lib.hm.dag.entryAfter ["linkGeneration" "reloadSystemd"] ''
  echo "ðŸš Configurando env.nu para Nushell..."

  mkdir -p "$HOME/.config/nushell"

  $DRY_RUN_CMD cat > $HOME/.config/nushell/env.nu << 'EOFNUENV'
  # Auto-generated by home-manager

  $env.PATH = (
    $env.PATH
    | split row (char esep)
    | prepend /run/current-system/sw/bin
    | prepend $"($env.HOME)/.nix-profile/bin"
    | prepend /nix/var/nix/profiles/default/bin
    | prepend $"($env.HOME)/.local/bin"
    | prepend $"($env.HOME)/.cargo/bin"
    | uniq
  )

  $env.EDITOR = "nvim"
  $env.XDG_CONFIG_HOME = $"($env.HOME)/.config"
  EOFNUENV

  echo "    âœ… env.nu configurado con PATH de NixOS"
'';
```

---

## ðŸ” Troubleshooting

### âŒ "Command `sops` not found"

**Problema:** No se hizo rebuild despuÃ©s de agregar `sops`.

**SoluciÃ³n:**
```bash
darwin-rebuild switch --flake ~/.config/nixos
```

---

### âŒ "sops found but PATH is incomplete"

**Problema:** `env.nu` no se generÃ³ correctamente.

**SoluciÃ³n:**
```bash
# 1. Verificar que env.nu existe
cat ~/.config/nushell/env.nu

# 2. Si estÃ¡ vacÃ­o o sin PATH, hacer rebuild
darwin-rebuild switch --flake ~/.config/nixos

# 3. Abrir NUEVO terminal
nu
which sops  # Debe funcionar
```

---

### âŒ "Variables de entorno vacÃ­as"

**Problema:** Secretos no desencriptados o rebuild incompleto.

**SoluciÃ³n:**
```bash
# 1. Verificar que secretos existen
ls -la ~/.config/sops-nix/secrets/

# 2. Si no existen, crear secretos primero
cd ~/.config/nixos
sops secrets/ai.yaml
# [Agregar secretos]

# 3. Rebuild
darwin-rebuild switch --flake ~/.config/nixos

# 4. Nuevo terminal
nu
echo $env.OPENAI_API_KEY  # Debe mostrar valor
```

---

### âŒ "env.nu es sobrescrito en cada rebuild"

**CORRECTO:** Eso es intencional.

**FilosofÃ­a:**
- âœ… `env.nu` â†’ Gestionado por Nix (auto-generado)
- âœ… `config.nu` â†’ Gestionado por ti (manual)

Si quieres agregar configuraciÃ³n personalizada:
```bash
# Edita config.nu (no env.nu)
nvim ~/.config/nushell/config.nu

# Agrega tus aliases, funciones, etc.
# Esto NO se sobrescribirÃ¡
```

---

## ðŸ’¡ FilosofÃ­a de ConfiguraciÃ³n

### **GestiÃ³n Mixta (Lo Mejor de Dos Mundos)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nix Gestiona (Declarativo)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - InstalaciÃ³n de paquetes (sops, age) â”‚
â”‚  - PATH configuration                   â”‚
â”‚  - Variables de entorno de secretos    â”‚
â”‚  - env.nu (generado automÃ¡ticamente)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario Gestiona (Manual)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - config.nu (aliases, funciones)      â”‚
â”‚  - Temas y personalizaciÃ³n             â”‚
â”‚  - Plugins de nushell                  â”‚
â”‚  - Scripts personalizados              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Checklist de VerificaciÃ³n

```bash
# [ ] 1. Rebuild completado sin errores
darwin-rebuild switch --flake ~/.config/nixos

# [ ] 2. sops estÃ¡ disponible
nu
which sops
# /run/current-system/sw/bin/sops

# [ ] 3. age estÃ¡ disponible
which age
# /run/current-system/sw/bin/age

# [ ] 4. PATH incluye rutas de Nix
echo $env.PATH | str contains "/run/current-system/sw/bin"
# true

# [ ] 5. env.nu existe y tiene contenido
cat ~/.config/nushell/env.nu
# Debe tener configuraciÃ³n de PATH

# [ ] 6. Puede editar secretos
cd ~/.config/nixos
sops secrets/ai.yaml
# Editor se abre âœ…

# [ ] 7. Variables de entorno disponibles (si ya tienes secretos)
echo $env.OPENAI_API_KEY
# Debe mostrar valor o error si secreto no existe
```

---

## ðŸŽ¯ Resumen

**Antes:**
```bash
nu
sops secrets/ai.yaml
# Error: Command `sops` not found âŒ
```

**DespuÃ©s:**
```bash
nu
sops secrets/ai.yaml
# Editor se abre en texto plano âœ…
# Editas â†’ Guardas â†’ Se encripta automÃ¡ticamente âœ…
echo $env.OPENAI_API_KEY
# sk-proj-xxxxx âœ…
```

---

**Creado:** 2025-02-06
**Problema resuelto:** Nushell no encontraba `sops`
**SoluciÃ³n:** PATH configurado automÃ¡ticamente via home-manager
