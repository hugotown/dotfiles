{ config, inputs, pkgs, lib, hostname, ... }:
{
  home.stateVersion = "24.11";
  home.homeDirectory = "/Users/hugoruiz";

  programs.home-manager.enable = true;

  # ===== SOPS SECRET MANAGEMENT =====

  sops = {
    # Age key location for macOS
    # Esta es tu llave PRIVADA que desencripta los secretos
    age.keyFile = "${config.home.homeDirectory}/Library/Application Support/sops/age/keys.txt";

    # Default secrets file (can be overridden per secret)
    # IMPORTANTE: Rutas relativas desde este archivo a /secrets/
    # desde hosts/darwin/work-mp-m3-max/home/hugoruiz/ ‚Üí secrets/ (5 niveles arriba)
    defaultSopsFile = ../../../../../secrets/gemini_api_key.yaml;

    # Define individual secrets
    # Cada secret ser√° desencriptado a: ~/.config/sops-nix/secrets/<name>
    secrets = {
      # Google API Keys
      gemini_api_key = {
        sopsFile = ../../../../../secrets/gemini_api_key.yaml;
        key = "GEMINI_API_KEY";  # Nombre de la llave dentro del archivo YAML
      };
      google_api_key = {
        sopsFile = ../../../../../secrets/google_api_key.yaml;
        key = "GOOGLE_API_KEY";  # Nombre de la llave dentro del archivo YAML
      };

      # AI Service API Keys (from ai.yaml) - Comentados hasta crear archivo
      # openai_api_key = {};
      # anthropic_api_key = {};

      # Database credentials (from database.yaml) - Comentados hasta crear archivo
      # postgres_password = {
      #   sopsFile = ../../../../secrets/database.yaml;
      # };
      # mysql_password = {
      #   sopsFile = ../../../../secrets/database.yaml;
      # };
      # redis_password = {
      #   sopsFile = ../../../../secrets/database.yaml;
      # };

      # GitHub tokens (from github.yaml) - Comentados hasta crear archivo
      # github_token = {
      #   sopsFile = ../../../../secrets/github.yaml;
      # };
      # gh_token = {
      #   sopsFile = ../../../../secrets/github.yaml;
      # };
    };
  };

  # ===== DECLARATIVE SHELL INTEGRATIONS =====

  # Zoxide - smart cd
  # NOTE: All shell integrations are disabled because we manage them manually
  # via home.activation.generateShellIntegrations which creates ~/.zoxide.{fish,nu,zsh,bash}
  programs.zoxide = {
    enable = true;
    enableFishIntegration = false;
    enableZshIntegration = false;
    enableNushellIntegration = false;
    enableBashIntegration = false;
  };

  # Atuin - shell history search
  # NOTE: All shell integrations are disabled because we manage them manually
  # via home.activation.generateShellIntegrations which creates ~/.atuin.{fish,nu,zsh,bash}
  programs.atuin = {
    enable = true;
    enableFishIntegration = false;
    enableZshIntegration = false;
    enableNushellIntegration = false;
    enableBashIntegration = false;
  };

  # Starship - cross-shell prompt
  # NOTE: All shell integrations are disabled because we manage them manually
  # via home.activation.generateShellIntegrations which creates ~/.starship.{fish,nu,zsh,bash}
  # User configuration lives in ~/.config/starship.toml (editable without rebuild)
  programs.starship = {
    enable = true;
    enableFishIntegration = false;
    enableZshIntegration = false;
    enableNushellIntegration = false;
    enableBashIntegration = false;
  };

  # Fish shell - User manages config manually in ~/.config/fish/
  # Philosophy: Nix installs ‚Üí User configures in ~/.config
  programs.fish.enable = false;

  # Zsh configuration - managed manually in ~/.zshrc
  # Nix only installs zsh, user configures in ~/.config per philosophy
  programs.zsh = {
    enable = false;  # Disabled: user manages shell config manually
  };

  # Nushell configuration
  # NOTE: We only enable programs.nushell for package installation and basic setup.
  # Config files are managed separately:
  #   - env.nu: Generated by xdg.configFile (see below) with SOPS secrets
  #   - config.nu: User-managed in ~/.config/nushell/config.nu
  #   - Integrations: Generated by home.activation.generateShellIntegrations
  programs.nushell = {
    enable = true;
  };

  # Explicitly generate nushell env.nu with SOPS secrets
  xdg.configFile."nushell/env.nu".text = ''
    # Configure PATH for Nix/Darwin
    $env.PATH = (
      $env.PATH
      | split row (char esep)
      | prepend /run/current-system/sw/bin
      | prepend $"($env.HOME)/.nix-profile/bin"
      | prepend /nix/var/nix/profiles/default/bin
      | prepend $"($env.HOME)/.local/bin"
      | prepend $"($env.HOME)/.npm-global/bin"
      | prepend $"($env.HOME)/.cargo/bin"
      | uniq
    )

    # Environment variables
    $env.EDITOR = "nvim"
    $env.TERMINAL = "alacritty"

    # SOPS configuration for CLI usage
    $env.SOPS_AGE_KEY_FILE = $"($env.HOME)/Library/Application Support/sops/age/keys.txt"

    # Load secrets from sops-nix para Nushell
    # str trim elimina espacios/newlines al final
    $env.GEMINI_API_KEY = (open ${config.sops.secrets.gemini_api_key.path} | str trim)
    $env.GOOGLE_API_KEY = (open ${config.sops.secrets.google_api_key.path} | str trim)
  '';

  # Fish environment configuration with SOPS secrets
  # NOTE: Following the "Exception Rule" - keeping Nix-managed files OUTSIDE ~/.config/
  # Fish will source this from user's ~/.config/fish/config.fish
  home.file.".fish_env".text = ''
    # Auto-generated by home-manager - DO NOT EDIT MANUALLY
    # SOPS-managed secrets and environment variables

    # Configure PATH for Nix/Darwin
    fish_add_path --prepend --global $HOME/.cargo/bin
    fish_add_path --prepend --global $HOME/.npm-global/bin
    fish_add_path --prepend --global $HOME/.local/bin
    fish_add_path --prepend --global /nix/var/nix/profiles/default/bin
    fish_add_path --prepend --global $HOME/.nix-profile/bin
    fish_add_path --prepend --global /run/current-system/sw/bin

    # Environment variables
    set -gx EDITOR nvim
    set -gx TERMINAL alacritty

    # SOPS configuration for CLI usage
    set -gx SOPS_AGE_KEY_FILE "$HOME/Library/Application Support/sops/age/keys.txt"

    # Load secrets from sops-nix for Fish
    # string trim removes trailing whitespace/newlines
    set -gx GEMINI_API_KEY (cat ${config.sops.secrets.gemini_api_key.path} | string trim)
    set -gx GOOGLE_API_KEY (cat ${config.sops.secrets.google_api_key.path} | string trim)
  '';

  # ===== SESSION CONFIGURATION =====

  home.sessionVariables = {
    EDITOR = "nvim";
    TERMINAL = "alacritty";
  };

  home.sessionPath = [
    "${config.home.homeDirectory}/.local/bin"
    "${config.home.homeDirectory}/.npm-global/bin"
  ];

  home.file.".hushlogin".text = "";

  # Zsh environment and secrets - source this from your manual ~/.zshrc with: source ~/.zshrc.secrets
  home.file.".zshrc.secrets".text = ''
    # Auto-generated by home-manager - DO NOT EDIT MANUALLY
    # SOPS-managed secrets and environment variables

    # Configure PATH for Nix/Darwin
    export PATH="$HOME/.cargo/bin:$HOME/.npm-global/bin:$HOME/.local/bin:/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/run/current-system/sw/bin:$PATH"

    # Environment variables
    export EDITOR=nvim
    export TERMINAL=alacritty

    # SOPS configuration for CLI usage
    export SOPS_AGE_KEY_FILE="$HOME/Library/Application Support/sops/age/keys.txt"

    # Load secrets from sops-nix for Zsh
    export GEMINI_API_KEY="$(cat ${config.sops.secrets.gemini_api_key.path} | tr -d '\n')"
    export GOOGLE_API_KEY="$(cat ${config.sops.secrets.google_api_key.path} | tr -d '\n')"
  '';

  # ===== HAMMERSPOON SYMLINK =====

  home.activation.hammerspoon = lib.hm.dag.entryAfter ["writeBoundary"] ''
    # Create Hammerspoon symlink from ~/.config/hammerspoon to ~/.hammerspoon
    CONFIG_DIR="$HOME/.config/hammerspoon"
    HAMMERSPOON_DIR="$HOME/.hammerspoon"

    # Backup existing directory if it's not a symlink
    if [ -d "$HAMMERSPOON_DIR" ] && [ ! -L "$HAMMERSPOON_DIR" ]; then
      $DRY_RUN_CMD mv "$HAMMERSPOON_DIR" "$HAMMERSPOON_DIR.backup.$(date +%Y%m%d_%H%M%S)"
      echo "üî® Backed up existing Hammerspoon config"
    fi

    # Remove old symlink if it exists and points to wrong location
    if [ -L "$HAMMERSPOON_DIR" ] && [ "$(readlink "$HAMMERSPOON_DIR")" != "$CONFIG_DIR" ]; then
      $DRY_RUN_CMD rm "$HAMMERSPOON_DIR"
      echo "üî® Removed old Hammerspoon symlink"
    fi

    # Create symlink if it doesn't exist
    if [ ! -e "$HAMMERSPOON_DIR" ]; then
      $DRY_RUN_CMD ln -sf "$CONFIG_DIR" "$HAMMERSPOON_DIR"
      echo "‚úÖ Hammerspoon symlink created: $HAMMERSPOON_DIR -> $CONFIG_DIR"
    else
      echo "‚úÖ Hammerspoon symlink already exists"
    fi
  '';

  # ===== KARABINER-ELEMENTS CONFIG =====

  home.activation.karabiner = lib.hm.dag.entryAfter ["writeBoundary"] ''
    # Ensure Karabiner config directory exists
    KARABINER_CONFIG_DIR="$HOME/.config/karabiner"

    # Create directory structure if it doesn't exist
    if [ ! -d "$KARABINER_CONFIG_DIR" ]; then
      $DRY_RUN_CMD mkdir -p "$KARABINER_CONFIG_DIR/assets/complex_modifications"
      echo "‚å®Ô∏è  Created Karabiner config directory"
    fi

    # Verify config file exists
    if [ -f "$KARABINER_CONFIG_DIR/karabiner.json" ]; then
      echo "‚úÖ Karabiner config ready: $KARABINER_CONFIG_DIR/karabiner.json"
    else
      echo "‚ö†Ô∏è  Karabiner config not found. Please create ~/.config/karabiner/karabiner.json"
    fi
  '';

  # ===== LAUNCHD AGENTS =====

  launchd.agents.xdg-config = {
    enable = true;
    config = {
      ProgramArguments = [
        "/bin/sh"
        "-c"
        "/bin/launchctl setenv XDG_CONFIG_HOME $HOME/.config"
      ];
      RunAtLoad = true;
    };
  };

  launchd.agents.hammerspoon = {
    enable = true;
    config = {
      ProgramArguments = [
        "/Applications/Hammerspoon.app/Contents/MacOS/Hammerspoon"
      ];
      RunAtLoad = true;
      KeepAlive = false;
      StandardOutPath = "/tmp/hammerspoon.out.log";
      StandardErrorPath = "/tmp/hammerspoon.err.log";
    };
  };

  launchd.agents.karabiner = {
    enable = true;
    config = {
      ProgramArguments = [
        "/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-Elements"
      ];
      RunAtLoad = true;
      KeepAlive = false;
      StandardOutPath = "/tmp/karabiner.out.log";
      StandardErrorPath = "/tmp/karabiner.err.log";
    };
  };

  # launchd.agents.sketchybar = {
  #   enable = true;
  #   config = {
  #     ProgramArguments = [
  #       "${pkgs.sketchybar}/bin/sketchybar"
  #     ];
  #     KeepAlive = true;
  #     RunAtLoad = true;
  #     StandardOutPath = "/tmp/sketchybar.out.log";
  #     StandardErrorPath = "/tmp/sketchybar.err.log";
  #     EnvironmentVariables = {
  #       PATH = "/run/current-system/sw/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin";
  #     };
  #   };
  # };

  # ===== BASH CONFIGURATION =====
  # Bash is configured declaratively for full integration
  programs.bash = {
    enable = true;
    shellAliases = {
      cldy = "claude --dangerously-skip-permissions";
    };
    initExtra = ''
      # Load shell integration files generated by activation scripts
      [ -f ~/.zoxide.bash ] && source ~/.zoxide.bash
      [ -f ~/.atuin.bash ] && source ~/.atuin.bash
      [ -f ~/.starship.bash ] && source ~/.starship.bash
      [ -f ~/.yazi.bash ] && source ~/.yazi.bash
    '';
  };

  # ===== OUT-OF-THE-BOX SHELL INTEGRATION =====
  # This activation script ensures that all shells work immediately after installation
  # Philosophy: "Nix installs ‚Üí User configures" maintained by generating auxiliary files
  # that users source in their configs, rather than overwriting user configs

  home.activation.generateShellIntegrations = lib.hm.dag.entryAfter ["writeBoundary"] ''
    echo ""
    echo "üêö ================================================"
    echo "üêö Generando integraciones de shell out-of-the-box"
    echo "üêö ================================================"
    echo ""

    # ===== STEP 1: Generate integration files =====
    echo "üì¶ Paso 1/4: Generando archivos de integraci√≥n..."
    echo ""

    # Zoxide integration files
    if [ -x "${pkgs.zoxide}/bin/zoxide" ]; then
      $DRY_RUN_CMD ${pkgs.zoxide}/bin/zoxide init fish > $HOME/.zoxide.fish 2>/dev/null && echo "  ‚úÖ .zoxide.fish"
      $DRY_RUN_CMD ${pkgs.zoxide}/bin/zoxide init nushell > $HOME/.zoxide.nu 2>/dev/null && echo "  ‚úÖ .zoxide.nu"
      $DRY_RUN_CMD ${pkgs.zoxide}/bin/zoxide init zsh > $HOME/.zoxide.zsh 2>/dev/null && echo "  ‚úÖ .zoxide.zsh"
      $DRY_RUN_CMD ${pkgs.zoxide}/bin/zoxide init bash > $HOME/.zoxide.bash 2>/dev/null && echo "  ‚úÖ .zoxide.bash"
    else
      echo "  ‚ö†Ô∏è  zoxide no encontrado"
    fi

    # Atuin integration files
    if [ -x "${pkgs.atuin}/bin/atuin" ]; then
      $DRY_RUN_CMD mkdir -p $HOME/.local/share/atuin
      $DRY_RUN_CMD ${pkgs.atuin}/bin/atuin init fish > $HOME/.atuin.fish 2>/dev/null && echo "  ‚úÖ .atuin.fish"
      $DRY_RUN_CMD ${pkgs.atuin}/bin/atuin init nu --disable-up-arrow > $HOME/.local/share/atuin/init.nu 2>/dev/null && echo "  ‚úÖ .local/share/atuin/init.nu"
      $DRY_RUN_CMD ${pkgs.atuin}/bin/atuin init zsh > $HOME/.atuin.zsh 2>/dev/null && echo "  ‚úÖ .atuin.zsh"
      $DRY_RUN_CMD ${pkgs.atuin}/bin/atuin init bash > $HOME/.atuin.bash 2>/dev/null && echo "  ‚úÖ .atuin.bash"
    else
      echo "  ‚ö†Ô∏è  atuin no encontrado"
    fi

    # Starship integration files
    if [ -x "${pkgs.starship}/bin/starship" ]; then
      $DRY_RUN_CMD ${pkgs.starship}/bin/starship init fish > $HOME/.starship.fish 2>/dev/null && echo "  ‚úÖ .starship.fish"
      $DRY_RUN_CMD ${pkgs.starship}/bin/starship init nu > $HOME/.starship.nu 2>/dev/null && echo "  ‚úÖ .starship.nu"
      $DRY_RUN_CMD ${pkgs.starship}/bin/starship init zsh > $HOME/.starship.zsh 2>/dev/null && echo "  ‚úÖ .starship.zsh"
      $DRY_RUN_CMD ${pkgs.starship}/bin/starship init bash > $HOME/.starship.bash 2>/dev/null && echo "  ‚úÖ .starship.bash"
    else
      echo "  ‚ö†Ô∏è  starship no encontrado"
    fi

    # Yazi wrapper functions
    $DRY_RUN_CMD cat > $HOME/.yazi.fish << 'EOF_YAZI_FISH'
# Yazi wrapper - cd to last directory on exit
function y
    set tmp (mktemp -t "yazi-cwd.XXXXXX")
    yazi $argv --cwd-file="$tmp"
    if read -z cwd <"$tmp"; and test -n "$cwd"; and test "$cwd" != "$PWD"
        builtin cd -- "$cwd"
    end
    rm -f -- "$tmp"
end
EOF_YAZI_FISH
    echo "  ‚úÖ .yazi.fish"

    $DRY_RUN_CMD cat > $HOME/.yazi.nu << 'EOF_YAZI_NU'
# Yazi wrapper - cd to last directory on exit
def --env y [...args] {
    let tmp = (mktemp -t "yazi-cwd.XXXXXX")
    yazi ...$args --cwd-file $tmp
    let cwd = (open $tmp)
    if $cwd != "" and $cwd != $env.PWD {
        cd $cwd
    }
    rm -fp $tmp
}
EOF_YAZI_NU
    echo "  ‚úÖ .yazi.nu"

    $DRY_RUN_CMD cat > $HOME/.yazi.bash << 'EOF_YAZI_BASH'
# Yazi wrapper - cd to last directory on exit
function y() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
    yazi "$@" --cwd-file="$tmp"
    IFS= read -r -d "" cwd < "$tmp"
    test -n "$cwd" && test "$cwd" != "$PWD" && builtin cd -- "$cwd"
    rm -f -- "$tmp"
}
EOF_YAZI_BASH
    echo "  ‚úÖ .yazi.bash"

    $DRY_RUN_CMD cat > $HOME/.yazi.zsh << 'EOF_YAZI_ZSH'
# Yazi wrapper - cd to last directory on exit
function y() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
    yazi "$@" --cwd-file="$tmp"
    IFS= read -r -d "" cwd < "$tmp"
    test -n "$cwd" && test "$cwd" != "$PWD" && builtin cd -- "$cwd"
    rm -f -- "$tmp"
}
EOF_YAZI_ZSH
    echo "  ‚úÖ .yazi.zsh"

    # cldy alias files
    $DRY_RUN_CMD cat > $HOME/.cldy.fish << 'EOF_CLDY_FISH'
# Claude skip permissions alias
alias cldy="claude --dangerously-skip-permissions"
EOF_CLDY_FISH
    echo "  ‚úÖ .cldy.fish"

    $DRY_RUN_CMD cat > $HOME/.cldy.nu << 'EOF_CLDY_NU'
# Claude skip permissions alias
alias cldy = claude --dangerously-skip-permissions
EOF_CLDY_NU
    echo "  ‚úÖ .cldy.nu"

    echo ""

    # ===== STEP 2: Create minimal configs if they don't exist =====
    echo "üìù Paso 2/4: Verificando configs de shells..."
    echo ""

    # Fish config
    if [ ! -f "$HOME/.config/fish/config.fish" ]; then
      $DRY_RUN_CMD mkdir -p "$HOME/.config/fish"
      $DRY_RUN_CMD cat > "$HOME/.config/fish/config.fish" << 'EOF_FISH_CONFIG'
# ~/.config/fish/config.fish
# Manual configuration - User editable
# Generated by Nix home-manager on first install

# Nix-Managed Environment (load FIRST)
source ~/.fish_env

# Shell integrations (auto-generated by Nix)
source ~/.zoxide.fish
source ~/.atuin.fish
source ~/.starship.fish
source ~/.yazi.fish
source ~/.cldy.fish

# Add your custom configuration below this line
# ============================================

EOF_FISH_CONFIG
      echo "  ‚úÖ Creado ~/.config/fish/config.fish (nuevo)"
    else
      echo "  ‚ÑπÔ∏è  ~/.config/fish/config.fish ya existe (no modificado)"
    fi

    # Nushell config.nu
    if [ ! -f "$HOME/.config/nushell/config.nu" ]; then
      $DRY_RUN_CMD mkdir -p "$HOME/.config/nushell"
      $DRY_RUN_CMD cat > "$HOME/.config/nushell/config.nu" << 'EOF_NU_CONFIG'
# ~/.config/nushell/config.nu
# Manual configuration - User editable
# Generated by Nix home-manager on first install

# Shell integrations (auto-generated by Nix)
source ~/.zoxide.nu
source ~/.local/share/atuin/init.nu
source ~/.starship.nu
source ~/.yazi.nu
source ~/.cldy.nu

# Add your custom configuration below this line
# ============================================

EOF_NU_CONFIG
      echo "  ‚úÖ Creado ~/.config/nushell/config.nu (nuevo)"
    else
      echo "  ‚ÑπÔ∏è  ~/.config/nushell/config.nu ya existe (no modificado)"
    fi

    # Nushell env.nu is managed by xdg.configFile in home.nix
    echo "  ‚úÖ Nushell env.nu ‚Üí Managed by xdg.configFile (includes secrets)"

    # Zsh config
    if [ ! -f "$HOME/.zshrc" ]; then
      $DRY_RUN_CMD cat > "$HOME/.zshrc" << 'EOF_ZSH_CONFIG'
# ~/.zshrc
# Manual configuration - User editable
# Generated by Nix home-manager on first install

# Load Nix-managed environment and secrets FIRST
[ -f ~/.zshrc.secrets ] && source ~/.zshrc.secrets

# Shell integrations (auto-generated by Nix)
[ -f ~/.zoxide.zsh ] && source ~/.zoxide.zsh
[ -f ~/.atuin.zsh ] && source ~/.atuin.zsh
[ -f ~/.starship.zsh ] && source ~/.starship.zsh
[ -f ~/.yazi.zsh ] && source ~/.yazi.zsh

# Alias
alias cldy="claude --dangerously-skip-permissions"

# Add your custom configuration below this line
# ============================================

EOF_ZSH_CONFIG
      echo "  ‚úÖ Creado ~/.zshrc (nuevo)"
    else
      echo "  ‚ÑπÔ∏è  ~/.zshrc ya existe (no modificado)"
    fi

    echo ""

    # ===== STEP 3: Auto-source in existing configs (idempotent) =====
    echo "üîó Paso 3/4: Verificando sourceo autom√°tico..."
    echo ""

    # Fish - add sources if not present
    if [ -f "$HOME/.config/fish/config.fish" ]; then
      for file in fish_env zoxide.fish atuin.fish starship.fish yazi.fish cldy.fish; do
        if ! grep -q "source ~/.$file" "$HOME/.config/fish/config.fish" 2>/dev/null; then
          $DRY_RUN_CMD echo "source ~/.$file" >> "$HOME/.config/fish/config.fish"
          echo "  ‚úÖ Fish: Agregado source ~/.$file"
        fi
      done
    fi

    # Nushell - add sources if not present
    if [ -f "$HOME/.config/nushell/config.nu" ]; then
      if ! grep -q "source ~/.zoxide.nu" "$HOME/.config/nushell/config.nu" 2>/dev/null; then
        $DRY_RUN_CMD echo "source ~/.zoxide.nu" >> "$HOME/.config/nushell/config.nu"
        echo "  ‚úÖ Nushell: Agregado source ~/.zoxide.nu"
      fi
      if ! grep -q "source ~/.local/share/atuin/init.nu" "$HOME/.config/nushell/config.nu" 2>/dev/null; then
        $DRY_RUN_CMD echo "source ~/.local/share/atuin/init.nu" >> "$HOME/.config/nushell/config.nu"
        echo "  ‚úÖ Nushell: Agregado source ~/.local/share/atuin/init.nu"
      fi
      if ! grep -q "source ~/.starship.nu" "$HOME/.config/nushell/config.nu" 2>/dev/null; then
        $DRY_RUN_CMD echo "source ~/.starship.nu" >> "$HOME/.config/nushell/config.nu"
        echo "  ‚úÖ Nushell: Agregado source ~/.starship.nu"
      fi
      if ! grep -q "source ~/.yazi.nu" "$HOME/.config/nushell/config.nu" 2>/dev/null; then
        $DRY_RUN_CMD echo "source ~/.yazi.nu" >> "$HOME/.config/nushell/config.nu"
        echo "  ‚úÖ Nushell: Agregado source ~/.yazi.nu"
      fi
      if ! grep -q "source ~/.cldy.nu" "$HOME/.config/nushell/config.nu" 2>/dev/null; then
        $DRY_RUN_CMD echo "source ~/.cldy.nu" >> "$HOME/.config/nushell/config.nu"
        echo "  ‚úÖ Nushell: Agregado source ~/.cldy.nu"
      fi
    fi

    # Zsh - add sources if not present
    if [ -f "$HOME/.zshrc" ]; then
      for integration in zoxide atuin starship yazi; do
        if ! grep -q "source ~/.$integration.zsh" "$HOME/.zshrc" 2>/dev/null; then
          # Find the right place to insert (after PATH but before custom config)
          if grep -q "# Add your custom configuration" "$HOME/.zshrc"; then
            $DRY_RUN_CMD sed -i.bak "/# Add your custom configuration/i [ -f ~/.$integration.zsh ] && source ~/.$integration.zsh" "$HOME/.zshrc"
            $DRY_RUN_CMD rm -f "$HOME/.zshrc.bak"
          else
            $DRY_RUN_CMD echo "[ -f ~/.$integration.zsh ] && source ~/.$integration.zsh" >> "$HOME/.zshrc"
          fi
          echo "  ‚úÖ Zsh: Agregado source ~/.$integration.zsh"
        fi
      done
    fi

    echo ""

    # ===== STEP 4: Summary =====
    echo "üìä Paso 4/4: Resumen de configuraci√≥n"
    echo ""
    echo "  ‚úÖ Fish    ‚Üí ~/.config/fish/config.fish (user-editable)"
    echo "  ‚úÖ Nushell ‚Üí ~/.config/nushell/config.nu + env.nu"
    echo "  ‚úÖ Zsh     ‚Üí ~/.zshrc (user-editable)"
    echo "  ‚úÖ Bash    ‚Üí Configurado v√≠a programs.bash"
    echo ""
    echo "üéâ Out-of-the-box shell integration completa!"
    echo ""
    echo "üí° Todas las shells ahora tienen:"
    echo "   - Atuin (Ctrl+R para b√∫squeda de historial)"
    echo "   - Zoxide (comando 'z' para navegaci√≥n inteligente)"
    echo "   - Yazi (comando 'y' wrapper con cd al salir)"
    echo "   - Alias 'cldy' (Claude skip permissions)"
    echo ""
    echo "üìù Filosof√≠a mantenida: 'Nix installs ‚Üí User configures'"
    echo "   Los archivos en ~/.config/ son editables por el usuario."
    echo "   Nix solo genera archivos auxiliares (~/.zoxide.fish, etc.)"
    echo ""
    echo "üêö ================================================"
    echo ""
  '';
}
