#!/usr/bin/env bash
set -euo pipefail

VAR_NAME="${1:-}"
VAR_VALUE="${2:-}"

if [ -z "$VAR_NAME" ] || [ -z "$VAR_VALUE" ]; then
    echo "Usage: add-secret VAR_NAME value" >&2
    exit 1
fi

AGE_KEY_FILE="$HOME/.local/share/sops/age/keys.txt"
if [ ! -f "$AGE_KEY_FILE" ]; then
    echo "Error: age key not found at $AGE_KEY_FILE" >&2
    exit 1
fi

# Extract age public key from private key file header
AGE_PUB="$(grep "^# public key:" "$AGE_KEY_FILE" | sed 's/# public key: //')"
if [ -z "$AGE_PUB" ]; then
    echo "Error: could not extract public key from $AGE_KEY_FILE" >&2
    exit 1
fi

SECRETS_DIR="$HOME/.config/secrets"
FILENAME="$(echo "$VAR_NAME" | tr '[:upper:]' '[:lower:]').yaml"
FILEPATH="$SECRETS_DIR/$FILENAME"

TMPFILE="$(mktemp)"
trap 'rm -f "$TMPFILE"' EXIT

printf '%s: %s\n' "$VAR_NAME" "$VAR_VALUE" > "$TMPFILE"

sops --age "$AGE_PUB" -e "$TMPFILE" > "$FILEPATH"

git -C "$HOME/.config" add "secrets/$FILENAME"
git -C "$HOME/.config" commit -m "secret: add/update $VAR_NAME"

echo "âœ“ $VAR_NAME encrypted and committed to secrets/$FILENAME" >&2
